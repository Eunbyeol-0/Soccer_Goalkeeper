<root BTCPP_format="4">
  <include path="./cam_find_and_track_ball.xml" />
  <include path="./locate.xml" />
  <include path="./find_ball.xml" />

  <BehaviorTree ID="Goalkeeper">
    <ReactiveSequence>
      <!-- 자기 위치 추정 -->
      <SelfLocate mode="trust_direction" />

      <!-- 공 위치 알 때만 로컬라이제이션(공 위치에 대한 find상태가 아님을 의미)-->
      <SubTree ID="Locate" _autoremap="true" _while="decision!='find'" />

      <!-- 상대 킥오프 대기 -->
      <ReactiveSequence _while="wait_for_opponent_kickoff" name="상대 팀 킥오프 대기">
        <SubTree ID="CamFindAndTrackBall" _autoremap="true" />
        <SetVelocity />
      </ReactiveSequence>

      <!-- 정상 경기 -->
      <ReactiveSequence _while="!wait_for_opponent_kickoff" name="정상 경기">
        <!-- 공이 아웃된 경우 -->
        <Sequence _while="ball_out">
          <SubTree ID="CamFindAndTrackBall" _autoremap="true" />
          <GoBackInField />
          <SubTree ID="Locate" _autoremap="true" _while="decision!='find'" />
        </Sequence>

        <!-- 공이 인플레이 -->
        <ReactiveSequence _while="!ball_out">
          <ReactiveSequence>
            <!-- 공 추적 -->
            <SubTree ID="CamFindAndTrackBall" _autoremap="true" />

            <!-- 행동 결정 -->
            <Sequence>
              <ReactiveSequence>
                <GoalieDecide decision_out="{decision}" decision_in="{decision}" />
                <!-- 공 찾기 -->
                <!-- <SubTree ID="FindBall" _while="decision=='find'" _autoremap="true" /> -->
              </ReactiveSequence>

              <ReactiveSequence _while="decision == 'hold'">
                <CalcGoliePos />
                <GolieMove stop_threshold="0.1" v_limit="0.7" />
              </ReactiveSequence>

              <ReactiveSequence _while="decision == 'clearing'">
	              <ReactiveSequence>
		              <GoalieClearingDecide decision_out="{clearing_decision}" decision_in="{clearing_decision}" />
		            </ReactiveSequence>
		            
                <Chase _while="clearing_decision == 'clearing_chase'" vx_limit="0.5" vy_limit="0.1" vtheta_limit="1.0" dist="0.4" safe_dist="0.5" />
                <Kick _while="clearing_decision == 'clearing_kick'" speed_limit="0.7" min_msec_kick="300" msecs_stablize="100" kick_type="one_touch" />
              </ReactiveSequence>

            </Sequence>
          </ReactiveSequence>
        </ReactiveSequence>
      </ReactiveSequence>
    </ReactiveSequence>
  </BehaviorTree>
</root>